







<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados | CAPTION</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='caption-theme.css') }}" rel="stylesheet">
</head>

<body>
    <nav class="navbar mb-4">
        <div class="container-fluid">
               <i class="bi bi-chat-square-text-fill"></i>
            <span class="navbar-brand mb-0 h1">CAPTION</span>
        </div>
    </nav>
    <div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
        <div class="card shadow p-4" style="width: 100%; max-width: 420px;">
            <h2 class="mb-3 text-center">¬°Transcripci√≥n Completa!</h2>
            <div class="alert alert-success text-center" role="alert">
                El archivo SRT est√° listo para descargar.
            </div>
            <div class="mb-3">
                <div class="row mb-2">
                    <div class="col-6 stat-label">Duraci√≥n:</div>
                    <div class="col-6" id="statDuration">02:13</div>
                </div>
                <div class="row mb-2">
                    <div class="col-6 stat-label">Hablantes:</div>
                    <div class="col-6" id="statSpeakers">2</div>
                </div>
                <div class="row mb-2">
                    <div class="col-6 stat-label">Precisi√≥n:</div>
                    <div class="col-6" id="statAccuracy">98%</div>
                </div>
            </div>
            <button class="btn btn-primary w-100 mb-3" id="downloadBtn">Descargar SRT</button>
            <button class="btn btn-success w-100 mb-3" id="burnSubtitlesBtn">üî• Quemar Subt√≠tulos en Video</button>
            <button class="btn btn-secondary w-100 mb-3" id="showFfmpegBtn" type="button">C√≥mo quemar
                subt√≠tulos</button>
            <div id="ffmpegSection" class="alert alert-dark mt-2" style="display:none; font-size:0.95em">
                <strong>Comando FFmpeg:</strong>
                <pre class="mt-2 mb-0" id="ffmpegCmd"
                    style="white-space:pre-wrap; word-break:break-all; background:transparent; color:var(--text-color); border:none; padding:0;"></pre>
                <div class="mt-2"><small>Ejecuta este comando en tu PC para incrustar los subt√≠tulos en el video
                        original.</small></div>
            </div>


            <div id="videoProcessingSection" class="alert alert-info mt-2" style="display:none;">
                <div class="text-center mb-3">
                    <h5 id="processingTitle">üé¨ Procesando Video...</h5>
                    <div class="progress mb-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="videoProgressBar"
                            role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="processingMessage">Iniciando procesamiento...</small>
                </div>
                <div id="videoDownloadSection" style="display:none;" class="text-center">
                    <button class="btn btn-success w-100" id="downloadVideoBtn">üì• Descargar Video con
                        Subt√≠tulos</button>
                </div>
            </div>








            <a href="/" class="btn btn-link w-100">Procesar otro video</a>
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const transcriptId = urlParams.get('transcript_id');
         let currentJobId = null;
        let statusInterval = null;


        if (!transcriptId) {
            console.error("No transcript_id found in URL parameters.");
            // Optionally, display an error message to the user
        }

        document.getElementById('downloadBtn').onclick = async function () {
            if (!transcriptId) {
                alert("Error: No se encontr√≥ el ID de la transcripci√≥n para descargar.");
                return;
            }

            this.disabled = true;
            this.textContent = 'Descargando...';

            try {
                const response = await fetch(`/download_srt/${transcriptId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al descargar el SRT.');
                }

                const srtContent = await response.text();
                const blob = new Blob([srtContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${transcriptId}.srt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Error during SRT download:", error);
                alert(`Error al descargar el SRT: ${error.message}`);
            } finally {
                this.disabled = false;
                this.textContent = 'Descargar SRT';
            }
        };


// Burn Subtitles Button Handler
        document.getElementById('burnSubtitlesBtn').onclick = async function () {
            if (!transcriptId) {
                alert("Error: No se encontr√≥ el ID de la transcripci√≥n.");
                return;
            }

            this.disabled = true;
            this.textContent = 'Iniciando...';

            try {
                const response = await fetch(`/burn_subtitles/${transcriptId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al iniciar procesamiento.');
                }

                const data = await response.json();
                currentJobId = data.job_id;
                
                // Show processing section
                document.getElementById('videoProcessingSection').style.display = 'block';
                
                // Start status polling
                startStatusPolling();
                
            } catch (error) {
                console.error("Error starting video processing:", error);
                alert(`Error: ${error.message}`);
                this.disabled = false;
                this.textContent = 'üî• Quemar Subt√≠tulos en Video';
            }
        };

        // Status Polling Function
        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            
            statusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/video_status/${currentJobId}`);
                    if (!response.ok) {
                        throw new Error('Error checking status');
                    }
                    
                    const status = await response.json();
                    updateProcessingUI(status);
                    
                    if (status.status === 'completed' || status.status === 'error') {
                        clearInterval(statusInterval);
                    }
                    
                } catch (error) {
                    console.error("Error checking video status:", error);
                    clearInterval(statusInterval);
                }
            }, 2000); // Check every 2 seconds
        }

        // Update Processing UI
        function updateProcessingUI(status) {
            const progressBar = document.getElementById('videoProgressBar');
            const messageEl = document.getElementById('processingMessage');
            const titleEl = document.getElementById('processingTitle');
            const downloadSection = document.getElementById('videoDownloadSection');
            const burnBtn = document.getElementById('burnSubtitlesBtn');
            
            // Update progress bar
            progressBar.style.width = `${status.progress || 0}%`;
            
            // Update message
            messageEl.textContent = status.message || 'Procesando...';
            
            if (status.status === 'completed') {
                titleEl.textContent = '‚úÖ ¬°Video Procesado!';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                downloadSection.style.display = 'block';
                burnBtn.style.display = 'none'; // Hide burn button
                
            } else if (status.status === 'error') {
                titleEl.textContent = '‚ùå Error en Procesamiento';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                messageEl.textContent = `Error: ${status.error || 'Error desconocido'}`;
                burnBtn.disabled = false;
                burnBtn.textContent = 'üî• Quemar Subt√≠tulos en Video';
                
            } else {
                // Processing states
                titleEl.textContent = 'üé¨ Procesando Video...';
            }
        }
        
        
        // Download Processed Video
        document.getElementById('downloadVideoBtn').onclick = async function () {
            if (!currentJobId) {
                alert("Error: No hay video procesado para descargar.");
                return;
            }

            this.disabled = true;
            this.textContent = 'Descargando...';

            try {
                // Direct download via browser
                window.location.href = `/download_video/${currentJobId}`;
                
            } catch (error) {
                console.error("Error downloading video:", error);
                alert(`Error al descargar el video: ${error.message}`);
            } finally {
                setTimeout(() => {
                    this.disabled = false;
                    this.textContent = 'üì• Descargar Video con Subt√≠tulos';
                }, 2000);
            }
        };














        

        const ffmpegCmd = `ffmpeg -i TU_VIDEO.mp4 -vf subtitles=${transcriptId}.srt -c:a copy video_con_subtitulos.mp4`;
        document.getElementById('showFfmpegBtn').onclick = function () {
            const section = document.getElementById('ffmpegSection');
            document.getElementById('ffmpegCmd').textContent = ffmpegCmd;
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        };
    </script>
</body>

</html>